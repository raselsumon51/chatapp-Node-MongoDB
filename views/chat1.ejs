<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  
 <script>
  var socket = io();
  var username = '<%= username %>';
  var mobileChatOpen = false; // track if chat is open on mobile

  function sendPrivateMessage(receiver) {
    var message = document.getElementById('messageInput').value;
    if (!message.trim()) return;
    socket.emit('chat message', { sender: username, receiver: receiver, message: message });
    document.getElementById('messageInput').value = '';
    appendMessage(message, 'self');
  }

  function appendMessage(message, type) {
    const li = document.createElement('li');
    li.className = type === 'self' ? 'flex justify-end mb-4' : 'flex justify-start mb-4';
    li.innerHTML = `<div class="message p-3 rounded ${type === 'self' ? 'bg-blue-500 text-white' : 'bg-gray-200'}">${message}</div>`;
    const messagesList = document.getElementById('messages-list');
    messagesList.appendChild(li);
    messagesList.scrollTop = messagesList.scrollHeight;
  }

  document.addEventListener('DOMContentLoaded', function() {
    socket.on('private message', function(data) {
      if (data.sender === username) {
        appendMessage(data.message, 'self');
      } else {
        appendMessage(data.message, 'other');
      }
    });
  });

  socket.on('connect', function() {
    socket.emit('join', username);
  });

  function openChat(receiver) {
    if (window.innerWidth < 768) {
      document.getElementById('peopleList').classList.add('hidden');
      document.getElementById('chatArea').classList.remove('hidden');
      mobileChatOpen = true;
    }
    document.getElementById('chatHeader').innerText = `Chat with ${receiver}`;
    document.getElementById('sendBtn').onclick = function() { sendPrivateMessage(receiver); };

    const messagesList = document.getElementById('messages-list');
    messagesList.scrollTop = messagesList.scrollHeight;
  }

  function goBack() {
    document.getElementById('chatArea').classList.add('hidden');
    document.getElementById('peopleList').classList.remove('hidden');
    mobileChatOpen = false;
  }

  window.addEventListener('resize', () => {
    if (window.innerWidth >= 768) {
      // Desktop: show both
      document.getElementById('peopleList').classList.remove('hidden');
      document.getElementById('chatArea').classList.remove('hidden');
    } else {
      // Mobile: hide chat if not opened
      if (!mobileChatOpen) {
        document.getElementById('chatArea').classList.add('hidden');
        document.getElementById('peopleList').classList.remove('hidden');
      }
    }
  });
</script>

</head>

<body class="bg-gray-100 h-screen flex flex-col md:flex-row">

  <!-- People List -->
  <div id="peopleList" class="w-full md:w-1/3 bg-[#F6F2EE] border-r border-gray-300 flex flex-col">
    <div class="p-4 md:p-6 flex-1 overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">People List</h2>
      <ul class="divide-y divide-gray-300">
        <% users.forEach(user => { %>
        <li class="py-2">
          <button class="flex items-center w-full text-left" onclick="openChat('<%= user.username %>')">
            <img width="50" height="50" src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar" class="rounded-full mr-2">
            <span class="text-base"><%= user.username %></span>
          </button>
        </li>
        <% }); %>
      </ul>
    </div>
    <div class="p-4">
      <a href="/logout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full w-full text-center block">Logout</a>
    </div>
  </div>

  <!-- Chat Area -->
  <div id="chatArea" class="w-full md:w-2/3 flex flex-col h-screen hidden md:flex">
    <!-- Mobile back button -->
    <div class="md:hidden p-2">
      <button onclick="goBack()" class="bg-gray-300 px-3 py-1 rounded">â¬… Back</button>
    </div>

    <div class="flex-1 p-4 overflow-y-auto">
      <h3 id="chatHeader" class="text-center py-2">Welcome</h3>
      <ul id="messages-list">
        <% messages.forEach(message => { %>
          <% if (message.sender === username) { %>
          <li class="flex justify-end mb-4">
            <div class="message my-message p-3 bg-blue-500 text-white rounded"><%= message.message %></div>
          </li>
          <% } else { %>
          <li class="flex justify-start mb-4">
            <div class="message other-message p-3 bg-gray-200 rounded"><%= message.message %></div>
          </li>
          <% } %>
        <% }); %>
      </ul>
    </div>

    <div class="p-4 flex gap-2 border-t border-gray-300">
      <input type="text" id="messageInput" class="flex-1 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 px-4 py-2" placeholder="Enter text here...">
      <button id="sendBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full">Send</button>
    </div>
  </div>

</body>
</html>
